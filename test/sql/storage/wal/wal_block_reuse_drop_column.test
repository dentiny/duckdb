# name: test/sql/storage/wal/wal_block_reuse_drop_column.test
# description: Verify blocks freed by DROP COLUMN are not reused before WAL truncation
# group: [wal]

load __TEST_DIR__/wal_block_reuse_drop_col.db

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
PRAGMA wal_autocheckpoint='1TB'

statement ok
SET write_buffer_row_group_count=1

# Create table with multiple VARCHAR columns
statement ok
CREATE TABLE t (a INTEGER PRIMARY KEY, b VARCHAR, c VARCHAR)

statement ok
INSERT INTO t SELECT i, 'col_b_' || i || repeat('x', 50), 'col_c_' || i || repeat('y', 50) FROM range(50000) t(i)

# Drop column c - frees its blocks
statement ok
ALTER TABLE t DROP COLUMN c

# Create new table that will reuse the freed blocks
statement ok
CREATE TABLE t2 (d DOUBLE)

statement ok
INSERT INTO t2 SELECT i * 1.5 FROM range(100000) t(i)

# Restart and verify both tables
restart

query I
SELECT COUNT(*) FROM t
----
50000

query I
SELECT COUNT(*) FROM t2
----
100000
