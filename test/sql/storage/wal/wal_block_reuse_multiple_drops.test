# name: test/sql/storage/wal/wal_block_reuse_multiple_drops.test
# description: Verify blocks from multiple dropped tables are not reused before WAL truncation
# group: [wal]

load __TEST_DIR__/wal_block_reuse_multi.db

statement ok
PRAGMA disable_checkpoint_on_shutdown

statement ok
PRAGMA wal_autocheckpoint='1TB'

statement ok
SET write_buffer_row_group_count=1

# Create and drop multiple tables
statement ok
CREATE TABLE t1 (a INTEGER PRIMARY KEY, b VARCHAR)

statement ok
INSERT INTO t1 SELECT i, 'data_' || i || repeat('a', 30) FROM range(30000) t(i)

statement ok
DROP TABLE t1

statement ok
CREATE TABLE t2 (a INTEGER PRIMARY KEY, c VARCHAR)

statement ok
INSERT INTO t2 SELECT i, 'info_' || i || repeat('b', 30) FROM range(30000) t(i)

statement ok
DROP TABLE t2

statement ok
CREATE TABLE t3 (a INTEGER PRIMARY KEY, d VARCHAR)

statement ok
INSERT INTO t3 SELECT i, 'text_' || i || repeat('c', 30) FROM range(30000) t(i)

statement ok
DROP TABLE t3

# Final table reuses blocks from all previous tables
statement ok
CREATE TABLE t_final (x DOUBLE)

statement ok
INSERT INTO t_final SELECT i * 2.5 FROM range(200000) t(i)

# Restart and verify
restart

query I
SELECT COUNT(*) FROM t_final
----
200000

query R
SELECT SUM(x) FROM t_final
----
24999900000.000000
